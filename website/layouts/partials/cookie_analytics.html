{{ $ccVer := default "3.1.0" (index .Site.Data.versions "cookieconsent_version") }}
{{ $privacyURL := .Site.Params.privacy_policy_url | default "#" }}
{{ $gaID := getenv "GA_MEASUREMENT_ID" }}
{{ $ampKey := getenv "AMPLITUDE_API_KEY" }}

{{ if hugo.IsServer }}
<script>
  window.__KONFLUX_DEBUG_ANALYTICS = true;
  window.__KONFLUX_DEBUG_ANALYTICS_CONFIG = { ga: {{ if $gaID }}true{{ else }}false{{ end }}, amp: {{ if $ampKey }}true{{ else }}false{{ end }} };
</script>
{{ end }}

<!-- CookieConsent v3 (Orest Bida) -->
<script src="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@{{ $ccVer }}/dist/cookieconsent.umd.js"></script>

{{ if or $gaID $ampKey }}
<script>
  window.__KONFLUX_DEBUG_ANALYTICS_LOG = function(context) {
    if (!window.__KONFLUX_DEBUG_ANALYTICS || !window.__KONFLUX_DEBUG_ANALYTICS_CONFIG) return;
    var c = window.__KONFLUX_DEBUG_ANALYTICS_CONFIG;
    var analyticsAllowed = window.CookieConsent && window.CookieConsent.acceptedCategory && window.CookieConsent.acceptedCategory('analytics');
    var ga = c.ga ? (analyticsAllowed ? 'configured, enabled' : 'configured, disabled') : 'not configured';
    var amp = c.amp ? (analyticsAllowed ? 'configured, enabled' : 'configured, disabled') : 'not configured';
    console.log('[Konflux] ' + context + ': Analytics category ' + (analyticsAllowed ? 'allowed' : 'denied') + '. GA4: ' + ga + ', Amplitude: ' + amp + '.');
  };
  window.__KONFLUX_APPLY_ANALYTICS_CONSENT = function() {
    var allowed = window.CookieConsent && window.CookieConsent.acceptedCategory && window.CookieConsent.acceptedCategory('analytics');
    if (typeof gtag === 'function') {
      gtag('consent', 'update', {
        'analytics_storage': allowed ? 'granted' : 'denied',
        'ad_storage': 'denied'
      });
    }
    if (window.amplitude && typeof amplitude.setOptOut === 'function') {
      try { amplitude.setOptOut(!allowed); } catch (e) { if (window.__KONFLUX_DEBUG_ANALYTICS) console.error('[Konflux] Amplitude setOptOut error:', e); }
    }
  };
</script>
{{ end }}

<script>
  window.CookieConsent.run({
    categories: {
      necessary: { enabled: true, readOnly: true },
      analytics: {}
    },
    language: {
      default: 'en',
      translations: {
        en: {
          consentModal: {
            title: 'We use cookies',
            description: 'We use cookies to improve your experience and analyze site traffic. You can choose to accept analytics cookies or reject non-essential cookies.',
            acceptAllBtn: 'Accept all',
            acceptNecessaryBtn: 'Reject all',
            showPreferencesBtn: 'Manage preferences'
          },
          preferencesModal: {
            title: 'Manage cookie preferences',
            acceptAllBtn: 'Accept all',
            acceptNecessaryBtn: 'Reject all',
            savePreferencesBtn: 'Save preferences',
            closeIconLabel: 'Close',
            sections: [
              { title: 'Strictly necessary', description: 'These cookies are essential for the site to function and cannot be disabled.', linkedCategory: 'necessary' },
              { title: 'Analytics', description: 'These cookies help us understand how visitors use the site (e.g. Google Analytics, Amplitude).', linkedCategory: 'analytics' },
              { title: 'More information', description: 'For details, see our <a href="{{ $privacyURL }}" target="_blank" rel="noopener">Privacy Statement</a>.' }
            ]
          }
        }
      }
    },
    guiOptions: { consentModal: { layout: 'box inline', position: 'bottom center' }, preferencesModal: { layout: 'box' } },
    onFirstConsent: function() {
      if (window.__KONFLUX_APPLY_ANALYTICS_CONSENT) window.__KONFLUX_APPLY_ANALYTICS_CONSENT();
      if (window.__KONFLUX_DEBUG_ANALYTICS_LOG) window.__KONFLUX_DEBUG_ANALYTICS_LOG('Cookie consent (first)');
    },
    onConsent: function() {
      if (window.__KONFLUX_APPLY_ANALYTICS_CONSENT) window.__KONFLUX_APPLY_ANALYTICS_CONSENT();
      if (window.__KONFLUX_DEBUG_ANALYTICS_LOG) window.__KONFLUX_DEBUG_ANALYTICS_LOG('Cookie consent');
    },
    onChange: function(detail) {
      if (window.__KONFLUX_APPLY_ANALYTICS_CONSENT) window.__KONFLUX_APPLY_ANALYTICS_CONSENT();
      if (window.__KONFLUX_DEBUG_ANALYTICS_LOG) window.__KONFLUX_DEBUG_ANALYTICS_LOG('Cookie preferences changed');
    }
  });
  // Apply consent on load for returning visitors who already accepted
  if (window.__KONFLUX_APPLY_ANALYTICS_CONSENT) setTimeout(window.__KONFLUX_APPLY_ANALYTICS_CONSENT, 0);
</script>

{{ if and hugo.IsServer (not $gaID) (not $ampKey) }}
<script>
  if (window.__KONFLUX_DEBUG_ANALYTICS) {
    console.log('[Konflux] Analytics scripts skipped: GA_MEASUREMENT_ID and AMPLITUDE_API_KEY are not set. Set env vars or add GitHub Actions secrets to enable.');
  }
</script>
{{ end }}
